<% extend CommonHelper %>
<div class="cart-content">
    <!-- 判斷購物車是否為空 -->
  <% if current_cart.blank? %>
    <div class="cart-empty">
      <h4>
        <%= fa_icon("shopping-cart lg", text: "購物車目前是空的唷~") %>        
      </h4>
      <%= link_to "BACK TO SHOPPING", products_path, class: "btn" %>
    </div>
  <% else %>
     <!-- simple form -->
    <%= simple_form_for current_cart , url:operations_cart_path(current_cart), method: :patch, remote: true do |f| %>
    <%= f.input_field "", name: "cart-items-count", value: current_cart.cart_items.count ,id: "total-cart-items-count" ,type: "hidden" %>
        <div class="table-responsive">
        <table class="table table-shopping">
          <thead>
            <tr>
              <!-- 全選 -->
              <th class="td-checkbox">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" class="cart-select-all"/>                    
                  </label>
                  <span>全選</span>
                </div>
              </th>
              <th class="products-info"><span>商品資訊</span></th>
              <th class="text-center" style="width: 15%;">尺寸 / 數量</th>
              <th class="text-right">單價</th>
              <th class="text-right">小計</th>
              <th class="text-right"style="padding-right: 35px;">刪除</th>
            </tr>
          </thead>
          <tbody>
            <!-- 使用each_with_index方法，給每個商品加上編號好用 checkbox 控制 -->
            <% @cart_items.each_with_index do |item, index| %>
              <%= render "carts/cart_item", f: f, item: item, index: index %>
            <% end %>            
            <tr>
              <td class="checked-to-delete" colspan="3">
                <small>已選擇 <span id="checked-cart_items-count">0</span> 件</small>
                <%= button_tag type: "button",data: {toggle: "modal", target: "#confirm-dialog" },class: "btn btn-raised btn-checked disabled",onclick: "confirmRemoveCartItems()" do %>
                刪除選中商品
                <% end%>
                <%= f.button :submit, value: true, name: "delete_items", class: "invisible", id: "cart-btn-delete-all" %>
              </td>
              <td colspan="3" class="td-total-price">
                <span>Total</span>
                <small>$</small>
                <span id="total-price">           
                </span>
              </td>
              <td></td>
            </tr>
            <!-- 结算按钮 -->
            <tr>
              <td colspan="7" class="text-right">
                <%= f.button :submit, name: "checkout", value: true, class: "btn-checkout btn btn-raised btn-info btn-round" do %>
                去结算
                <i class="material-icons">keyboard_arrow_right</i>
                <% end %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    <% end %>
  <% end %>
</div>

<script type='text/javascript'>
var check_function  = (function() {
  const totalcheckedcount = parseInt(document.getElementById('total-cart-items-count').value);
  const checked_count_by_delete = document.getElementById('checked-cart_items-count');  
    //多選
    let checkall = () => {          
    if (totalcheckedcount > 0) {
      document.getElementsByClassName('cart-select-all')[0].addEventListener('change',function(e){          
          for(let i=0;i< totalcheckedcount ;i++)
          {
            document.getElementById('cart-item-select-'+i).checked = this.checked;	
          }          
          if (this.checked) {
            checked_count_by_delete.innerHTML = totalcheckedcount;
            disabled_or_not(this.checked);
          }
          else
          {
            checked_count_by_delete.innerHTML = 0;
            disabled_or_not(false);
          }
          e.preventDefault();
        },false)
      };       
    }          
    //單選
    let checksingle = () => {
      for (let index = 0; index < totalcheckedcount; index++) {
        const element = document.getElementById('cart-item-select-' + index);        
        element.addEventListener('change',function(e) {  
          let delete_count_value = parseInt(checked_count_by_delete.innerHTML);
          if (this.checked) {            
            checked_count_by_delete.innerHTML = delete_count_value += 1;
          } else {
            checked_count_by_delete.innerHTML = delete_count_value -= 1;
          }
          e.preventDefault();
        });
      }
    }
    let disabled_or_not = (bool) =>{
      const tweak_disabled= document.getElementsByClassName('btn-checked')[0].classList;
      if (bool) {
        tweak_disabled.remove('disabled');
      } else {
        tweak_disabled.add('disabled');
      }
    }
    //取得所有function
    let allfunctoin = () =>{
      checkall(); 
      checksingle();
    }
    return{
      checkall: checkall,
      checksingle: checksingle,
      check_function_init: allfunctoin,
    };
}());
(function() {      
  check_function.check_function_init();
})();
</script>